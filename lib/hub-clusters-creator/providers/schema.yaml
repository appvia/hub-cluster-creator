---
providers:
  #
  ## AKS provider configuration
  #
  aks:
    type: object
    title: Azure AKS Provider configuration
    description: >
      Defines the configuration required to initialize the provider.
    required:
      - client_id
      - client_secret
      - region
      - subscription
      - tenant
    additionalProperties: false

    properties:
      client_id:
        $id: '#/config/client_id'
        type: string
        title: Service Principal Client ID
        description: >
          The associated client id from the service principal account you are
          using to speak to the Azure API.
        default: ''
        pattern: ^.*$

      client_secret:
        $id: '#/config/client_secret'
        type: string
        title: Service Principal Client Secret
        description: >
          The client secret of the service principal being used to provision
          the resources with.
        default: ''
        pattern: ^.*$

      region:
        $id: '#/config/region'
        type: string
        title: Azure Compute Region
        description: >
          The geographical region which you wish to build the cluster with.
        default: ''
        examples:
          - uksouth
        pattern: ^.*$

      subscription:
        $id: '#/config/subscription'
        type: string
        title: Subsription
        description: >
          The Azure client subscription you are using to provison the resources
          under.
        default: ''
        pattern: ^.*$

      tenant:
        $id: '#/config/tenant'
        type: string
        title: Tenant ID
        description: >
          The application tenant id from the application registration / service
          principal you are using. This can be found under the Application
          Registration tab in the Azure portal
        default: ''
        pattern: ^.*$
  #
  ## GKE provider configuration
  #
  gke:
    type: object
    title: Provider configuration
    description: >
      Defined the provider configuration options required to initialize the
      provider integration
    required:
      - account
      - project
      - region
    additionalProperties: false

    properties:
      account:
        $id: '#/config/account'
        type: string
        title: Service Account Credentials JSON
        description: ->
          The credentials used to speak the GCP APIs; you create a service
          account under the Cloud IAM within the project, adding the
          permissions 'Compute Admin' role to the service account via IAM
          tab. Once done you can create a key under 'Service Accounts'
          and copy and paste the JSON payload here.
        default: ''
        pattern: ^.*$

      project:
        $id: '#/config/project'
        type: string
        title: GCP Project
        description: >
          The name of the GCP project you are provisioning the cluster done.
        default: ''
        pattern: ^.*$

      region:
        $id: '#/config/region'
        type: string
        title: GCP Region
        description: >
          The GCP region you wish to the cluster to reside within.
        default: ''
        examples:
          - europe-west2
        pattern: ^.*$

#
## Cluster configuration
#
defaults:
  aks:
    defaults:
      machine_type:
        default: Standard_DS2_v2
        examples:
          - Standard_DS2_v2
      version:
        default: 1.14.3
        examples:
          - 1.14.3
          - 1.13.0
    required:
      - disk_size_gb
      - domain
      - machine_type
      - name
      - services_ipv4_cidr
      - size
      - ssh_key
      - version
  gke:
    defaults:
      machine_type:
        default: n1-standard-1
        examples:
          - n1-standard-1
      version:
        default: 1.13.7-gke.8
        examples:
          - 1.13.7-gke.8
          - latest
    required:
      - description
      - disk_size_gb
      - domain
      - enable_autoscaler
      - enable_autoupgrade
      - enable_binary_authorization
      - enable_horizontal_pod_autoscaler
      - enable_http_loadbalancer
      - enable_istio
      - enable_logging
      - enable_monitoring
      - enable_private_endpoint
      - enable_private_network
      - image_type
      - machine_type
      - maintenance_window
      - name
      - network
      - size
      - subnetwork
      - version

schema:
  type: object
  title: Cluster configuration
  description: >
    The configuration options for the Kubernetes cluster
  additionalProperties: false

  properties:
    name:
      $id: '#/properties/name'
      type: string
      title: Cluster Name
      default: ''
      description: >
        The name of the cluster you are provision within the cloud provider
      examples:
        - dev
        - prod
      pattern: ^.*$

    description:
      $id: '#/properties/description'
      provider: [gke]
      type: string
      title: Description
      description: >
        A summary description for this cluster.
      default: ''
      examples:
        - Dev Cluster
      pattern: ^(.*)$

    domain:
      $id: '#/properties/domain'
      type: string
      title: DNS Domain
      default: ''
      description: >
        The dns domain which the cluster is using; this must be accessible from
        with inside the project.
      examples:
        - 'example.com'

    version:
      $id: '#/properties/version'
      type: string
      title: Initial Kubernetes Version
      description: >
        The initial kubernetes version which the cluster should configured with.
      pattern: ^(.*)$

    size:
      $id: '#/properties/size'
      type: integer
      title: Initial Node Size
      default: 1
      description: >
        The number of nodes per zone which should exist in the cluster.
      examples:
        - 1
        - 10

    max_size:
      $id: '#/properties/max_size'
      provider: [gke]
      type: integer
      title: Max Size
      default: 10
      description: >
        Assuming the autoscaler is enabled this is the maximum number
        nodes permitted.
      examples:
        - 10

    image_type:
      $id: '#/properties/image_type'
      provider: [gke]
      type: string
      title: Machine Image
      default: 'COS'
      description: >
        The operating system image the compute pool should use.
      examples:
        - COS
      pattern: ^(.*)$

    machine_type:
      $id: '#/properties/machine_type'
      type: string
      title: Machine Type
      description: >
        The machine type which the default nodes pool should use.
      pattern: ^(.*)$

    disk_size_gb:
      $id: '#/properties/disk_size_gb'
      type: integer
      title: Compute Disk Size (GB)
      default: 100
      description: >
        Is the size of the disk used by the compute nodes
      examples:
        - 100

    authorized_master_cidrs:
      $id: '#/properties/authorized_master_cidrs'
      provider: [gke]
      type: array
      title: Master Authorized Networks
      items:
        $id: '#/properties/authorized_master_cidrs/items'
        type: object
        title: Networks
        required:
          - name
          - cidr
        properties:
          name:
            $id: '#/properties/authorized_master_cidrs/items/properties/name'
            type: string
            title: Display Name
            default: 'allowany'
            examples:
              - any
            pattern: ^(.*)$
          cidr:
            $id: '#/properties/authorized_master_cidrs/items/properties/cidr'
            type: string
            title: Network CIDR
            default: '0.0.0.0/0'
            examples:
              - 0.0.0.0/0
            pattern: ^([\d]{1,3}\.){3}[\d]{1,3}\/[\d]{1,2}$

    ssh_key:
      $id: '#/properties/ssh_key'
      provider: [aks]
      type: string
      title: SSH Public Key
      default: ''
      description: >
        A public ssh key used provision the compute nodes with
      examples:
        - ssh-rsa
      pattern: ^ssh-rsa.*$

    network:
      $id: '#/properties/network'
      provider: [gke]
      type: string
      title: GCP Network
      default: 'default'
      description: >
        The GCP network which the cluster should reside on, which have
        to be unique within the GCP project and created beforehand.
      examples:
        - 'default'
      pattern: ^(.*)$

    subnetwork:
      $id: '#/properties/subnetwork'
      provider: [gke]
      type: string
      title: Subnetwork for Nodes
      default: 'default'
      description: >
        The name of the GCP subnetwork which the cluster nodes should reside.
      examples:
        - default
      pattern: ^(.*)$

    create_subnetwork:
      $id: '#/properties/create_subnetwork'
      provider: [gke]
      type: boolean
      title: Create Subnetwork
      description: >
        Indicates if you wish to create a new subnetwork to place the
        compute node on to.
      default: false
      examples:
        - false
        - true

    services_ipv4_cidr:
      $id: '#/properties/services_ipv4_cidr'
      type: string
      title: Cluster Services CIDR
      default: ''
      description: >
        The CIDR used by the pod network, this is optional in GKE, but required
        in AKS.
      examples:
        - '10.0.0.0/16'
      pattern: ^(([\d]{1,3}\.){3}[\d]{1,3}\/[\d]{1,2}|)$

    cluster_ipv4_cidr:
      $id: '#/properties/cluster_ipv4_cidr'
      provider: [gke]
      type: string
      title: Cluster Pod Network
      default: ''
      description: >
        An optional network CIDR which is used to place the pod network on
        (else the cloud provider chooses)
      examples:
        - '10.20.0.0/16'
      pattern: ^(([\d]{1,3}\.){3}[\d]{1,3}\/[\d]{1,2}|)$

    github_client_id:
      $id: '#/properties/github_client_id'
      type: string
      title: Github Client ID
      default: ''
      description: >
        The Github client id for the oauth2 application
      examples:
        - ''
      pattern: ^(.*)$

    github_client_secret:
      $id: '#/properties/github_client_secret'
      type: string
      title: Github Client Secret
      default: ''
      description: >
        The Github client secret taken from the oauth2 application
      examples:
        - ''
      pattern: ^(.*)$

    grafana_disk_size:
      $id: '#/properties/grafana_disk_size'
      type: integer
      title: Grafana Disk Size
      default: 10
      description: >
        The size of the disk used for grafana instance
      examples:
        - 10
        - 100

    grafana_hostname:
      $id: '#/properties/grafana_hostname'
      type: string
      title: Grafana Hostname
      default: 'grafana'
      description: >
        The dns hostname which grafana should be configured to respond to.
      examples:
        - grafana
        - metrics
      pattern: ^(.*)$

    grafana_version:
      $id: '#/properties/grafana_version'
      type: string
      title: Grafana Version
      default: '6.2.5'
      description: >
        The version of the grafana which should be installed.
      examples:
        - 6.2.5
      pattern: ^(.*)$

    enable_autorepair:
      $id: '#/properties/enable_autorepair'
      provider: [gke]
      type: boolean
      title: Node Autorepair
      default: true
      description: >
        Indicates if the cluster should be configured with auto repair
        is enabled
      examples:
        - false
        - true

    enable_autoscaler:
      $id: '#/properties/enable_autoscaler'
      provider: [gke]
      type: boolean
      title: Cluster Autoscaling
      default: true
      description: >
        Indicates if the cluster should be configured with cluster autoscaling
        turned on
      examples:
        - false
        - true

    enable_autoupgrade:
      $id: '#/properties/enable_autoupgrade'
      provider: [gke]
      type: boolean
      title: Cluster Autoupgrading
      default: true
      description: >
        Indicates if the cluster should be configured with autograding
        enabled; meaning both nodes are masters are autoscated scheduled
        to upgrade during your maintenance window.
      examples:
        - false
        - true

    enable_binary_authorization:
      $id: '#/properties/enable_binary_authorization'
      provider: [gke]
      type: boolean
      title: Binary Authorization Service
      default: false
      description: >
        Indicates if the cluster should be configured with GKE Binary
        Authorization service enabled.
      examples:
        - false
        - true

    enable_horizontal_pod_autoscaler:
      $id: '#/properties/enable_horizontal_pod_autoscaler'
      provider: [gke]
      type: boolean
      title: Horizontal Pod Autoscaler
      default: false
      description: >
        Indicates if the cluster is configured with the horizontal
        pod autoscaler addon. This automatically adjusts the cpu and
        memory resources of pods in accordances with their demand. You
        should ensure you use PodDisruptionBudgets if this is enabled.
      examples:
        - false
        - true

    enable_http_loadbalancer:
      $id: '#/properties/enable_http_loadbalancer'
      provider: [gke]
      type: boolean
      title: HTTP Ingress Controller
      default: true
      description: >
        Indicates if the cluster should be configured with the GKE
        ingress controller. When enabled GKE will autodiscover your
        ingress resources and provision load balancer on your behalf.
      examples:
        - false
        - true

    enable_istio:
      $id: '#/properties/enable_istio'
      provider: [gke]
      type: boolean
      title: Istio Service Mesh
      default: false
      description: >
        Indicates if the GKE Istio service mesh is deployed to the
        cluster; this provides a more feature rich routing and
        instrumentation.
      examples:
        - false
        - true

    enable_logging:
      $id: '#/properties/enable_logging'
      provider: [gke]
      type: boolean
      title: Stackdriver Logging
      default: false
      description: >
        Indicates if Stackdriver metrics should be enabled for the cluster
      examples:
        - false
        - true

    enable_monitoring:
      $id: '#/properties/enable_monitoring'
      provider: [gke]
      type: boolean
      title: Stackdriver Metrics
      default: false
      description: >
        Indicates if Stackdriver logging should be enabled for the cluster
      examples:
        - false
        - true

    enable_private_endpoint:
      $id: '#/properties/enable_private_endpoint'
      provider: [gke]
      type: boolean
      title: Private Endpoints
      default: false
      description: >
        Indicates if the master api endpoint should be accessible from private
        network only i.e. no external access
      examples:
        - false
        - true

    enable_private_network:
      $id: '#/properties/enable_private_network'
      provider: [gke]
      type: boolean
      title: Private Node Networking
      default: true
      description: >
        Indicates if compute nodes should have external ip addresses or use
        private networking and a cloud-nat device.
      examples:
        - false
        - true

    master_ipv4_cidr_block:
      $id: '#/properties/master_ipv4_cidr_block'
      provider: [gke]
      type: string
      title: Master Peer Network Block
      default: '172.16.0.0/28'
      description: >
        If private networking is enabled, this is the peering subnet used
        to to GKE master api layer. Note, this must be unique within the
        network.
      examples:
        - '172.16.0.0/28'
      pattern: ^([\d]{1,3}\.){3}[\d]{1,3}\/[\d]{1,2}$

    maintenance_window:
      $id: '#/properties/maintenance_window'
      provider: [gke]
      type: string
      title: Maintenance Window
      default: '03:00'
      description: >
        Specifies the maintenance window in hours and minutes which GKE
        is permitted to run maintenance operations.
      examples:
        - '03:00'
      pattern: ^[\d]{2}:[\d]{2}$

    preemptible:
      $id: '#/properties/preemptible'
      provider: [gke]
      type: boolean
      title: Preemptible Nodes
      default: false
      description: >
        Indicates if the default pool created should use preemptible nodes.
      examples:
        - false
        - true
