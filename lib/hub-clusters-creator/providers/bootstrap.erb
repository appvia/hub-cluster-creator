---
<%-
  enable_network_policies = true
  enable_pod_security = true
  grafana_hostname = "#{context[:grafana_hostname]}.#{context[:domain]}"
  grafana_image_version = context[:grafana_version] || 'latest'
  grafana_password = context[:grafana_password]
  grafana_svc = 'NodePort'
  grafana_tags = {}
  case context[:provider]
  when 'eks'
    grafana_tags = {
      'service.beta.kubernetes.io/aws-load-balancer-backend-protocol':'http'
    }
    grafana_svc = 'LoadBalancer'
  end
-%>
apiVersion: v1
kind: ConfigMap
metadata:
  name: bootstrap
  namespace: kube-system
data:
  charts: |
    loki/loki-stack,metrics,--values /config/bundles/grafana.yaml
  repositories: |
    loki,https://grafana.github.io/loki/charts
  grafana.yaml: |
    loki:
      enabled: true
      networkPolicy:
        enabled: <%= enable_network_policies %>
    promtail:
      enabled: true
    prometheus:
      enabled: true
      server:
        fullnameOverride: prometheus-server
      nodeExporter:
        podSecurityPolicy:
          enabled: <%= enable_pod_security %>
      networkPolicy:
        enabled: <%= enable_network_policies %>
    grafana:
      enabled: true
      adminPassword: <%= grafana_password %>
      image:
        repository: grafana/grafana
        tag: <%= grafana_image_version %>
        pullPolicy: IfNotPresent
      sidecar:
        datasources:
          enabled: true
      service:
        type: <%= grafana_svc %>
        <%- if grafana_tags.size > 0 -%>
        annotations:
        <%- grafana_tags.each_pair do |k,v| -%>
          '<%= k %>': '<%= v %>'
        <%- end -%>
        <%- end -%>
        port: 80
        targetPort: 3000
      ingress:
        <%- if grafana_svc == 'NodePort' -%>
        enabled: true
        <%- else -%>
        enabled: false
        <%- end -%>
        hosts:
          - <%= grafanaHostname %>
        path: '/*'
      networkPolicy:
        enabled: <%= enable_network_policies %>
      persistence:
        enabled: true
        accessModes:
          - ReadWriteOnce
        size: <%= context[:grafana_disk_size] %><%= context[:grafana_disk_size].to_s.end_with?('Gi') ? '' : 'Gi' %>
      grafana.ini:
        server:
          domain: <%= grafana_hostname %>
          root_url: http://<%= grafana_hostname %>
        paths:
          data: /var/lib/grafana/data
          logs: /var/log/grafana
          plugins: /var/lib/grafana/plugins
          provisioning: /etc/grafana/provisioning
        analytics:
          check_for_updates: true
        log:
          mode: console
        grafana_net:
          url: https://grafana.net
        <%- unless (context[:github_client_id] || '').empty? -%>
        auth.github:
          allow_sign_up: true
          <%- unless (context[:github_organization] || '').empty? %>
          allowed_organizations: <%= context[:github_organization] %>
          <%- end %>
          api_url: https://api.github.com/user
          auth_url: https://github.com/login/oauth/authorize
          client_id: <%= context[:github_client_id] %>
          client_secret: <%= context[:github_client_secret] %>
          enabled: true
          scopes: user,read:org
          token_url: https://github.com/login/oauth/access_token
        <%- end -%>
